import{EditorState}from"https://esm.sh/@codemirror/state@6.4.0";import{EditorView,basicSetup}from"https://esm.sh/codemirror@6.0.1?deps=@codemirror/state@6.4.0";import{markdown}from"https://esm.sh/@codemirror/lang-markdown@6.2.5?deps=@codemirror/state@6.4.0";document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("editor-container");e.innerHTML="";const t="fotg-content",n=localStorage.getItem(t)||"# Welcome to Markdown Viewer\n\nStart typing your markdown here...",o=document.getElementById("preview-container"),r=document.getElementById("word-count");let i=null;async function d(e){let t=e.replace(/!\[video\]\((.*?)\)/gi,(e,t)=>`<video controls style="max-width: 100%; height: auto; border-radius: 6px; margin: 1rem 0;"><source src="${t}"></video>`);const n=window.marked.parse(t),i=window.DOMPurify.sanitize(n,{ADD_TAGS:["video","source"],ADD_ATTR:["controls","src","style"]});o.innerHTML=i;const d=n.replace(/<[^>]*>?/gm,"").trim().split(/\s+/).filter(e=>e.length>0).length,c=e.length;r.textContent=`${d} word${1!==d?"s":""} | ${c} char${1!==c?"s":""}`,window.hljs&&o.querySelectorAll("pre code").forEach(e=>{e.classList.contains("language-mermaid")||window.hljs.highlightElement(e)});const a=o.querySelectorAll("pre code.language-mermaid");if(a.length>0){if(window.mermaid){const e="dark"===document.documentElement.getAttribute("data-theme");window.mermaid.initialize({startOnLoad:!1,theme:e?"dark":"default"})}else{const e=await import("https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs");window.mermaid=e.default;const t="dark"===document.documentElement.getAttribute("data-theme");window.mermaid.initialize({startOnLoad:!1,theme:t?"dark":"default"})}for(let e=0;e<a.length;e++){const t=a[e],n=t.parentElement,o=t.textContent,r=`mermaid-${Date.now()}-${e}`;try{const{svg:e}=await window.mermaid.render(r,o),t=document.createElement("div");t.className="mermaid-rendered",t.style.display="flex",t.style.justifyContent="center",t.style.margin="1rem 0",t.innerHTML=e,n.replaceWith(t)}catch(e){console.error("Mermaid render error",e);const t=document.createElement("div");t.style.color="#ef4444",t.style.fontSize="0.85rem",t.style.marginBottom="0.5rem",t.textContent="Mermaid syntax error",n.insertAdjacentElement("beforebegin",t)}}}}const c=EditorView.updateListener.of(e=>{if(e.docChanged){const n=e.state.doc.toString();localStorage.setItem(t,n),clearTimeout(i),i=setTimeout(()=>{d(n)},300)}}),a=EditorView.theme({"&":{height:"100%",backgroundColor:"transparent",color:"var(--text-primary)"},"&.cm-focused":{outline:"none"},".cm-content":{fontFamily:"var(--font-mono)",fontSize:"14px",padding:"var(--space-2) 0"},".cm-gutters":{backgroundColor:"var(--bg-secondary)",color:"var(--text-muted)",borderRight:"1px solid var(--border-color)",fontFamily:"var(--font-mono)"},".cm-activeLine":{backgroundColor:"var(--editor-active-line)"},".cm-activeLineGutter":{backgroundColor:"var(--editor-active-line)"},".cm-cursor, .cm-dropCursor":{borderLeftColor:"var(--text-primary)"}}),l=(e,t=e)=>{const n=s.state.update({changes:s.state.selection.ranges.map(n=>({from:n.from,to:n.to,insert:`${e}${s.state.doc.sliceString(n.from,n.to)}${t}`})),selection:{anchor:s.state.selection.main.anchor+e.length,head:s.state.selection.main.head+e.length}});return s.dispatch(n),s.focus(),!0},s=new EditorView({state:EditorState.create({doc:n,extensions:[basicSetup,markdown(),a,c]}),parent:e});document.addEventListener("keydown",e=>{if(e.ctrlKey||e.metaKey)switch(e.key.toLowerCase()){case"b":e.preventDefault(),l("**");break;case"i":e.preventDefault(),l("*");break;case"k":e.preventDefault(),l("[","](url)");break;case"s":e.preventDefault(),document.getElementById("btn-save")?.click()}});const m=s.scrollDOM;let g=!1,u=!1,h=!0;m.addEventListener("scroll",()=>{if(h){if(!g){u=!0;const e=m.scrollTop/(m.scrollHeight-m.clientHeight);isNaN(e)||(o.scrollTop=e*(o.scrollHeight-o.clientHeight))}g=!1}},{passive:!0}),o.addEventListener("scroll",()=>{if(h){if(!u){g=!0;const e=o.scrollTop/(o.scrollHeight-o.clientHeight);isNaN(e)||(m.scrollTop=e*(m.scrollHeight-m.clientHeight))}u=!1}},{passive:!0});const v=document.getElementById("btn-sync-scroll");v&&v.addEventListener("click",()=>{h=!h,v.classList.toggle("active",h)});const p=document.getElementById("main-content"),w=document.getElementById("btn-view-editor"),E=document.getElementById("btn-view-split"),y=document.getElementById("btn-view-preview"),f=[w,E,y];function b(e){p.classList.remove("view-editor","view-preview"),f.forEach(e=>e?.classList.remove("active")),"editor"===e?(p.classList.add("view-editor"),w?.classList.add("active")):"preview"===e?(p.classList.add("view-preview"),y?.classList.add("active")):E?.classList.add("active")}w?.addEventListener("click",()=>b("editor")),E?.addEventListener("click",()=>b("split")),y?.addEventListener("click",()=>b("preview")),document.getElementById("btn-bold")?.addEventListener("click",()=>l("**")),document.getElementById("btn-italic")?.addEventListener("click",()=>l("*")),document.getElementById("btn-link")?.addEventListener("click",()=>l("[","](url)")),document.getElementById("btn-code")?.addEventListener("click",()=>l("\n```\n","\n```\n")),document.getElementById("btn-mermaid")?.addEventListener("click",()=>l("\n```mermaid\n","\n```\n")),document.getElementById("btn-image")?.addEventListener("click",()=>l("![alt text](","image_url_here)")),document.getElementById("btn-video")?.addEventListener("click",()=>l("![video](","video_url_here)")),document.getElementById("btn-export")?.addEventListener("click",()=>{const e=o.innerHTML,t=new Blob([`<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>Markdown Viewer Export</title>\n<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css">\n<style>\n  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 2rem; }\n  pre { background: #f4f4f4; padding: 1rem; border-radius: 6px; overflow-x: auto; }\n  code { font-family: monospace; }\n  img { max-width: 100%; height: auto; }\n  blockquote { border-left: 4px solid #ccc; margin-left: 0; padding-left: 1rem; color: #666; }\n</style>\n</head>\n<body>\n${e}\n</body>\n</html>`],{type:"text/html"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="export.html",r.click(),URL.revokeObjectURL(n)}),document.getElementById("btn-print")?.addEventListener("click",()=>{window.print()}),d(n),window.addEventListener("theme-changed",()=>{d(s.state.doc.toString())});const k=document.getElementById("btn-save"),L=document.getElementById("btn-open");k&&k.addEventListener("click",()=>{const e=s.state.doc.toString(),t=new Blob([e],{type:"text/markdown"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="document.md",o.click(),URL.revokeObjectURL(n)}),L&&L.addEventListener("click",()=>{const e=document.createElement("input");e.type="file",e.accept=".md,.txt,text/markdown,text/plain",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{const t=e.target.result;s.dispatch({changes:{from:0,to:s.state.doc.length,insert:t}})},n.readAsText(t)},e.click()});const x=document.getElementById("btn-reset"),B=document.getElementById("reset-dialog"),I=document.getElementById("btn-dialog-confirm"),S=document.getElementById("btn-dialog-cancel");x&&B&&(x.addEventListener("click",()=>{B.showModal()}),S.addEventListener("click",()=>{B.close()}),B.addEventListener("click",e=>{e.target===B&&B.close()}),I.addEventListener("click",()=>{s.dispatch({changes:{from:0,to:s.state.doc.length,insert:""}}),B.close()}))});